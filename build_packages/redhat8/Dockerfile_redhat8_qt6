FROM redhat/ubi8:8.10-1020 as builder-stage

# Prepare environment
RUN dnf update -y && \
  dnf install -y \
  unzip \
  curl \
  cmake \
  ninja-build \
  git \
  zlib-devel \
  gcc \
  gcc-c++ && \
  dnf clean all && rm -rf /var/cache/yum


# Get Qt 6
RUN git clone --branch 6.7.1 --depth 1 git://code.qt.io/qt/qt5.git qt6 \
	&& cd qt6 \
	&& perl init-repository --module-subset=qtbase,qtmultimedia,qtshadertools,qtcharts

RUN dnf -y install pulseaudio-libs-devel mesa-libGL-devel \
        xcb-util-renderutil-devel xcb-util-cursor-devel xcb-util-image-devel \
        libX11-devel xcb-util-wm-devel xcb-util-keysyms-devel libxkbcommon-x11-devel \
        wayland-devel fontconfig-devel gcc-toolset-12-libstdc++-devel \
        glibc-devel pcre2-devel

# HACK: Helps prevent subsequent builds from trying to link with the system libraries
RUN dnf -y install pkg-config

ENV LD_LIBRARY_PATH=/usr/lib64
RUN cd qt6 \
        && mkdir qt6-build \
        && cd qt6-build \
        && ../configure -xcb -feature-wayland -verbose -no-feature-gssapi -no-feature-ffmpeg -no-feature-system-zlib -no-feature-forkfd_pidfd \
        && cmake --build . --parallel \
        && cmake --install . \
        && cd ../.. \
        && rm -rf qt6